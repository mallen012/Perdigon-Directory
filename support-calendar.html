<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Support Calendar</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #23272e;
      font-family: Montserrat, sans-serif;
      color: #f3f3fa;
      padding: 20px;
    }
    a.calendar-link {
      font-size: 0.9em;
      color: #7ad0ff;
      text-decoration: underline;
    }
    .agenda-widget {
      background: #292e36;
      border-radius: 12px;
      padding: 18px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 10px #0002;
    }
    .agenda-section-title {
      font-size: 1.4em;
      color: #ffe066;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .agenda-day {
      background: #23272e;
      color: #ffd900;
      padding: 8px 14px;
      font-size: 1.1em;
      border-bottom: 1px solid #323650;
      cursor: pointer;
    }
    .agenda-list {
      padding: 8px 14px 14px 18px;
    }
    .agenda-event {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
    }
    .agenda-time {
      font-weight: bold;
      color: #4f46e5;
      width: 72px;
    }
    .agenda-title {
      flex-grow: 1;
    }
    .agenda-join {
      margin-left: 8px;
      background: #25d366;
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 700;
      font-size: .95em;
    }
    .agenda-empty {
      color: #aaa;
      padding: 12px 0;
    }
  </style>
</head>
<body>
  <div class="agenda-widget">
    <div class="agenda-section-title">Support Calendar</div>
    <div>
      <a class="calendar-link" href="https://calendar.google.com/calendar/u/0/r?cid=support@perdigon-group.com" target="_blank">
        support@perdigon-group.com
      </a>
      <br>
    </div>
    <div class="agenda-day" onclick="toggleAgenda('today')"><strong>Today (click to minimize)</strong></div>
    <div class="agenda-list" id="agenda-today" style="display:block;"></div>
    <div class="agenda-day" onclick="toggleAgenda('tomorrow')"><strong>Tomorrow (click to minimize)</strong></div>
    <div class="agenda-list" id="agenda-tomorrow" style="display:block;"></div>
  </div>

  <script>
    const GCAL_ID = "support@perdigon-group.com";
    const API_KEY = "AIzaSyDqMNGC5RUnlzSxP3vbD8WKzt_qPfUzab0";
    const TIMEZONE = "America/Los_Angeles";

    function fetchAndRenderAgenda() {
      const now = new Date();
      const end = new Date(); end.setDate(now.getDate() + 2);

      const isoNoMs = dt => dt.toISOString().split(".")[0] + "Z";
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(GCAL_ID)}/events?key=${API_KEY}&singleEvents=true&orderBy=startTime&timeMin=${encodeURIComponent(isoNoMs(now))}&timeMax=${encodeURIComponent(isoNoMs(end))}&maxResults=20`;

      fetch(url).then(r => r.json()).then(data => {
        if (!data.items) {
          document.getElementById("agenda-today").innerHTML = "<div class='agenda-empty'>No events found.</div>";
          return;
        }

        const tz = TIMEZONE;
        const todayStr = new Date().toLocaleDateString("en-US", { timeZone: tz });
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toLocaleDateString("en-US", { timeZone: tz });

        const todayList = [], tomorrowList = [];

        data.items.forEach(ev => {
          const evDate = new Date(ev.start.dateTime || ev.start.date);
          const evDateStr = evDate.toLocaleDateString("en-US", { timeZone: tz });
          const group = evDateStr === todayStr ? "today" : evDateStr === tomorrowStr ? "tomorrow" : null;
          if (!group) return;

          const time = ev.start.dateTime ? new Date(ev.start.dateTime).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", timeZone: tz }) : "All Day";
          let join = "";
          if (ev.description) {
            const match = ev.description.match(/https:\/\/[^\s<\n]+/);
            if (match) join = match[0].trim();
          }

          const obj = { time, title: ev.summary || "(No Title)", join };
          (group === "today" ? todayList : tomorrowList).push(obj);
        });

        renderAgendaList("today", todayList);
        renderAgendaList("tomorrow", tomorrowList);
      });
    }

    function renderAgendaList(day, list) {
      const container = document.getElementById(`agenda-${day}`);
      if (!list.length) {
        container.innerHTML = "<div class='agenda-empty'>No events</div>";
        return;
      }
      container.innerHTML = list.map(item => `
        <div class="agenda-event">
          <span class="agenda-time">${item.time}</span>
          <span class="agenda-title">${item.title}</span>
          ${item.join ? `<a href="${item.join}" class="agenda-join" target="_blank">Join Meeting</a>` : ""}
        </div>
      `).join("");
    }

    function toggleAgenda(day) {
      const el = document.getElementById(`agenda-${day}`);
      const isHidden = el.style.display === "none";
      el.style.display = isHidden ? "block" : "none";
      const heading = document.querySelector(`.agenda-day[onclick*="${day}"] strong`);
      heading.textContent = isHidden ? `${capitalize(day)} (click to minimize)` : capitalize(day);
    }

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    document.addEventListener("DOMContentLoaded", fetchAndRenderAgenda);
  </script>
</body>
</html>
